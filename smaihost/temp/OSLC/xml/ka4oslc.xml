<!-- Licensed Materials - Property of IBM 5724-C04 (C) -->
<!-- Copyright IBM Corporation 2013. All rights reserved. -->
<!-- US Government Users Restricted Rights - Use, duplication -->
<!-- or disclosure restricted by GSA ADP Schedule Contract with IBM Corp. -->

<?xml version="1.0" encoding="UTF-8"?>
<oslc_template xmlns:tmsoslc="http://localhost.com/tmsoslc" 
               xmlns:crtv="http://open-services.net/ns/crtv#" 
               xmlns:im="http://tivoli-OSLC-prototypes/ns/im#">
  <!-- This section is for query assembly mapping -->
  <tmsoslc:product>KA4</tmsoslc:product>
  <tmsoslc:when>@ checkVersionRange ${VERSION} MIN '06.30.00' *EQ 1</tmsoslc:when>
  <tmsoslc:interval minutes="1440"/>

  <tmsoslc:queries> 

	<!-- KA4MISC query for hostname, manufacturer, and type -->
    <tmsoslc:query name="q00" discovery="y">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'" 
      </tmsoslc:where>      
      <tmsoslc:tablename name="KA4MISC">
        <tmsoslc:columnname>FULLHOSTNM</tmsoslc:columnname>
        <tmsoslc:columnname>MANUFACTUR</tmsoslc:columnname>
        <tmsoslc:columnname>TYPE</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>
	
	<!-- KA4SVAL query for serial number and model -->
    <tmsoslc:query name="q01" discovery="y">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'" 
      </tmsoslc:where>      
      <tmsoslc:tablename name="KA4SVAL">
        <tmsoslc:columnname>QSRLNBR</tmsoslc:columnname>
        <tmsoslc:columnname>QMODEL</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

	<!-- KA4SYSTS query for partition ID (VMID) -->
    <tmsoslc:query name="q02" discovery="y">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'" 
      </tmsoslc:where>      
      <tmsoslc:tablename name="KA4SYSTS">
        <tmsoslc:columnname>PARTID</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

	<!-- KA4SYSTS query for total temp storage for percent memory -->
    <tmsoslc:query name="q04" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="KA4SYSTS">
        <tmsoslc:columnname>UNPROTSTG</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

	<!-- KA4PFJOB query for CPU percentage by job -->
    <tmsoslc:query name="q05" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY CPUPCTDLT DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="KA4PFJOB">
        <tmsoslc:columnname>SUBSYSTEM</tmsoslc:columnname>
        <tmsoslc:columnname>JOBNAME</tmsoslc:columnname>
        <tmsoslc:columnname>USERNAME</tmsoslc:columnname>
        <tmsoslc:columnname>JOBNUMBER</tmsoslc:columnname>
        <tmsoslc:columnname>CPUPCTDLT</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

	<!-- KA4PFJOB query for temp storage by job for percent memory -->
    <tmsoslc:query name="q06" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY TMPSTGJOB DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="KA4PFJOB">
        <tmsoslc:columnname>SUBSYSTEM</tmsoslc:columnname>
        <tmsoslc:columnname>JOBNAME</tmsoslc:columnname>
        <tmsoslc:columnname>TMPSTGJOB</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

	<!-- KA4DISKI5 query for percent disk usage for percent disk -->
    <tmsoslc:query name="q08" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY PCTUSED DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="KA4DISKI5">
        <tmsoslc:columnname>NAME</tmsoslc:columnname>
        <tmsoslc:columnname>PCTUSED</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>
	
	<!-- KA4TCPINT query for IP address -->
    <tmsoslc:query name="q09" discovery="y">
      <tmsoslc:where>
       "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="KA4TCPINT">
        <tmsoslc:columnname>IADDRESS</tmsoslc:columnname>
        <tmsoslc:columnname>LINENAME</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

	<!-- Method for formatting IP addresses -->
    <tmsoslc:query name="formatIPAddr" discovery="y">
      <tmsoslc:method>"@ KA4formatIPAddress ${q09}"</tmsoslc:method>
    </tmsoslc:query>

  </tmsoslc:queries> 

  <!-- Resource definition for ComputerSystem -->
  <tmsoslc:ResourceDefinition type="ComputerSystem">
    <im:list>
      <im:name name="host">
        <id name="itm:osType rdf:resource" value="@ KA4OSType ${HOSTINFO}" />
        <id name="crtv:manufacturer" value="@ getOSDPmanufacturer ${q00.MANUFACTUR}" />
        <id name="crtv:model" value="@ KA4Model ${q00.TYPE} ${q01.QMODEL}" />
        <id name="crtv:serialNumber" value="@ getOSDPserialNumber ${q01.QSRLNBR}" /> 
        <id name="crtv:vmid" value="@ getOSDPvmid ${q02.PARTID}" />
        <id name="crtv:fqdn" exclude="NO_DNS_ENTRY" value="@ KA4CheckFqdn ${q00.FULLHOSTNM}" />
        <id name="crtv:shortHostname" value="@ KA4CheckShorthostname ${q00.FULLHOSTNM}" />
        <namingGroupList name="ibmi">
           <namingGroup name="ibmi_mmsv">
              <namingMember>crtv:model</namingMember>
              <namingMember>crtv:manufacturer</namingMember>
              <namingMember>crtv:serialNumber</namingMember>
              <namingMember>crtv:vmid</namingMember>
           </namingGroup>
           <namingGroup name="ibmi_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>		   
        </namingGroupList>		
        <metrics>health</metrics>
      </im:name>
    </im:list>   
  </tmsoslc:ResourceDefinition>

  <!-- Resource definition for IPAddress -->
  <tmsoslc:ResourceDefinition type="IPAddress">
    <im:list>
      <im:name name="IP_Resource">
       <id name="crtv:contextAddressSpace rdf:resource" value="${formatIPAddr.CONTEXTAS}" />
       <id name="crtv:address" exclude="0.0.0.0,0:0:0:0:0:0:0:0,::" value="${formatIPAddr.IPADDRESS}" />	   
       <namingGroupList name="IP_address">
          <namingGroup name="IP_address_group">
             <namingMember>crtv:contextAddressSpace</namingMember>
             <namingMember>crtv:address</namingMember>
           </namingGroup>
       </namingGroupList>
       <relationship type="crtv:dependsOn">
          <target>
            <resourceType>ComputerSystem</resourceType>
            <resourceName>host</resourceName>
            <scope>this</scope>
          </target>
       </relationship>
      </im:name>
    </im:list>
  </tmsoslc:ResourceDefinition>

  <!-- Health metrics -->
  <metrics class="health">
  
    <record type="ComputerSystem">

      <metric name="itm:topProcessesforCPUUtil">
        <pattern type="sequence" name="topCPU-seq" limit="5" />
        <reference type="crtv:Process" about="${q05.JOBNAME}-${q05.JOBNUMBER}"  name="cpuUtilProcess" />
        <widget name="bar" order="1" width="200px" height="325px" title="CPU Utilization: Top 5 jobs" bundle-key="cpu_util_title" bundle-name="A4Bundle" />
      </metric>

      <metric name="itm:disksByPercentageSpaceUsed" >
        <pattern type="sequence" name="diskSpaceUsed-seq"  limit="5" />
        <reference type="crtv:StorageVolume" about="${q08.NAME}" name="diskUsed" />
        <widget name="bar" order="2" width="200px" height="325px"  title="Disk utilization %: Top 5 disk locations" bundle-key="disk_used_title"  bundle-name="A4Bundle" />
      </metric>  

    </record>

    <reference name="cpuUtilProcess" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q05.JOBNAME}-${q05.JOBNUMBER}-cpuUtil" reference-name="cpuUtilMetric" />
      <id name="dcterms:title" value="${q05.JOBNAME}" displayValue="${q05.JOBNAME}" column-name="Job" orderBy="2" axis="y" axis-type="string" column-bundle-key="job-title" column-bundle-name="A4Bundle" />
      <id name="crtv:processId" value="${q05.JOBNUMBER}" />
	</reference> 

    <reference name="cpuUtilMetric"> 
      <id name="dcterms:title" value="CPU Utilization" bundle-key="cpu_util_metric" bundle-name="A4Bundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
		  value="@ KA4CPUPercent ${q05.CPUPCTDLT} 1" 
		  displayValue="@ KA4CPUPercent ${q05.CPUPCTDLT} 1 display" 
          exclude="0.00,0.00%"  
	      orderBy="1" axis="x" axis-type="number" axis-range="0-100"
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="A4Bundle" />
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#CpuUsed" />
    </reference>
	
    <reference name="diskUsed" pmr="y">
      <sub-reference  property-name="ems:observes" reference-type="ems:Measure" reference-value="diskUsed-${q08.NAME}" reference-name="diskUsedMetric" />
      <id name="dcterms:title" value="${q08.NAME}" displayValue="${q08.NAME}" column-name="Disk Volume" axis="y" orderBy="2" axis-type="string" column-bundle-key="disk_title" column-bundle-name="A4Bundle"/>
    </reference> 

    <reference name="diskUsedMetric"> 
      <id name="dcterms:title" value="Percentage space used"  bundle-key="disk_used_metric" bundle-name="A4Bundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
	      value="@ KA4DiskPercent ${q08.PCTUSED}" 
		  displayValue="@ KA4DiskPercent ${q08.PCTUSED} display" 
          exclude="0.00,0.00%"  
		  orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
		  column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="A4Bundle"/> 
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#DiskSpaceUsed" />
    </reference>

  </metrics>

  <!-- KA4 specific methods -->
  <method library="ka4util.bin" name="KA4OSType" />
  <method library="ka4util.bin" name="KA4Model" />
  <method library="ka4util.bin" name="KA4formatIPAddress" />
  <method library="ka4util.bin" name="KA4CPUPercent" />
  <method library="ka4util.bin" name="KA4DiskPercent" />
  <method library="ka4util.bin" name="KA4CheckFqdn" />
  <method library="ka4util.bin" name="KA4CheckShorthostname" />

</oslc_template>          
  
    
