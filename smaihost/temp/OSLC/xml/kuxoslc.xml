<!-- Licensed Materials - Property of IBM 5724-C04 (C) -->
<!-- Copyright IBM Corporation 2013. All rights reserved. -->
<!-- US Government Users Restricted Rights - Use, duplication -->
<!-- or disclosure restricted by GSA ADP Schedule Contract with IBM Corp. -->

<?xml version="1.0" encoding="UTF-8"?>
<oslc_template xmlns:tmsoslc="http://localhost.com/tmsoslc"
               xmlns:crtv="http://open-services.net/ns/crtv#"
               xmlns:im="http://tivoli-OSLC-prototypes/ns/im#">
  <!-- This section is for query assembly mapping -->
  <tmsoslc:product>KUX</tmsoslc:product>
  <tmsoslc:when>@ checkVersionRange ${VERSION} MIN '06.22.00' *EQ 1</tmsoslc:when>
  <tmsoslc:interval minutes="1440"/>
  <tmsoslc:queries>
    <tmsoslc:query name="q0" discovery="y">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXMACHIN" application="OMUNX">
        <tmsoslc:columnname>HOSTNAME</tmsoslc:columnname>
        <tmsoslc:columnname>MACSERIAL</tmsoslc:columnname>
        <tmsoslc:columnname>MODEL</tmsoslc:columnname>
        <tmsoslc:columnname>UUID</tmsoslc:columnname>
        <tmsoslc:columnname>VENDOR</tmsoslc:columnname>
        <tmsoslc:columnname>VMID</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q1" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXMEM" application="OMUNX">
        <tmsoslc:columnname>MEMTOT</tmsoslc:columnname>
        <tmsoslc:columnname>VMTOT</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q2" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY CPUPERCENT DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXPS" application="OMUNX">
        <tmsoslc:columnname>BCMD</tmsoslc:columnname>
        <tmsoslc:columnname>CPUPERCENT</tmsoslc:columnname>
        <tmsoslc:columnname>PID</tmsoslc:columnname>		
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q3"  discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY VSIZE DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXPS" application="OMUNX">
        <tmsoslc:columnname>BCMD</tmsoslc:columnname>
        <tmsoslc:columnname>VSIZE</tmsoslc:columnname>
        <tmsoslc:columnname>PID</tmsoslc:columnname>		
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q4"  discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY SIZE DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXPS" application="OMUNX">
        <tmsoslc:columnname>BCMD</tmsoslc:columnname>
        <tmsoslc:columnname>SIZE</tmsoslc:columnname>
        <tmsoslc:columnname>PID</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q5" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY PCTSPCUSED DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXDISK" application="OMUNX">
        <tmsoslc:columnname>MOUNTPT</tmsoslc:columnname>
        <tmsoslc:columnname>PCTSPCUSED</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>
        
    <tmsoslc:query name="q6" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY PASAGTNAME"
      </tmsoslc:where>
      <tmsoslc:tablename name="KUXPASSTAT" application="OMUNX">
        <tmsoslc:columnname>INSTNAME</tmsoslc:columnname>
        <tmsoslc:columnname>PASAGTNAME</tmsoslc:columnname>
        <tmsoslc:columnname>TIMESTAMP</tmsoslc:columnname>
        <tmsoslc:columnname>STATUS</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q9" discovery="y">
      <tmsoslc:where>
       "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="UNIXIPADDR" application="OMUNX">
        <tmsoslc:columnname>IPADDRESS</tmsoslc:columnname>
        <tmsoslc:columnname>INTFNAME</tmsoslc:columnname>
        <tmsoslc:columnname>DNSNAME</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="formatIPAddr" discovery="y">
      <tmsoslc:method>"@ KUXformatIPAddress ${q9}"</tmsoslc:method>
    </tmsoslc:query>
    
  </tmsoslc:queries>

  <tmsoslc:ResourceDefinition type="ComputerSystem">
    <im:list>
      <im:name name="host">
        <id name="itm:osType rdf:resource" value="@ makeKUXOSType ${HOSTINFO}" />
        <id name="crtv:manufacturer" value="@ makeKUXManufacturer ${HOSTINFO}" />
        <id name="crtv:model" exclude="UNKNOWN" value="@ makeKUXModel ${HOSTINFO} ${q0.MODEL}" />
        <id name="crtv:serialNumber" exclude="UNKNOWN" value="@ makeKUXSerialNumber ${HOSTINFO} ${q0.MACSERIAL}" />
        <id name="crtv:systemBoardUUID" exclude="unknown" value="@ makeKUXSystemBoardUuid ${HOSTINFO} ${q0.UUID}" />
        <id name="crtv:vmid" exclude="NOT_AVAILABLE,global" value="@ makeKUXVmid ${HOSTINFO} ${q0.VMID}" />
        <id name="crtv:hostid" exclude="UNKNOWN" value="@ makeKUXHostid ${HOSTINFO} ${q0.UUID}" />        
        <id name="crtv:fqdn" exclude="NO_DNS_ENTRY" value="@ makeKUXFqdn ${q9} ${q0.HOSTNAME}" />
        <id name="crtv:shortHostname" value="@ makeKUXShorthostname ${q0.HOSTNAME}" />
        <!-- Naming group lists for AIX -->
        <namingGroupList name="aix" when="@ validateKUXOSType ${HOSTINFO} ${q0.VMID} *EQ 'aix'">
           <!-- Naming groups for AIX standalone  -->
           <namingGroup name="aix_mms">
              <namingMember>crtv:model</namingMember>
              <namingMember>crtv:manufacturer</namingMember>
              <namingMember>crtv:serialNumber</namingMember>
           </namingGroup>
           <namingGroup name="aix_u">
              <namingMember>crtv:systemBoardUUID</namingMember>
           </namingGroup>
           <namingGroup name="aix_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>
        </namingGroupList>
        <namingGroupList name="lpar" when="@ validateKUXOSType ${HOSTINFO} ${q0.VMID} *EQ 'lpar'">
           <!-- Naming groups for AIX LPARs  -->
           <namingGroup name="lpar_mmsv">
              <namingMember>crtv:model</namingMember>
              <namingMember>crtv:manufacturer</namingMember>
              <namingMember>crtv:serialNumber</namingMember>
              <namingMember>crtv:vmid</namingMember>
           </namingGroup>
           <namingGroup name="lpar_u">
              <namingMember>crtv:systemBoardUUID</namingMember>
           </namingGroup>
           <namingGroup name="lpar_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>
        </namingGroupList>
        <!-- Naming group list for HP-UX -->
        <namingGroupList name="hpux" when="@ validateKUXOSType ${HOSTINFO} ${q0.VMID} *EQ 'hpux'">
           <namingGroup name="hpux_u">
              <namingMember>crtv:systemBoardUUID</namingMember>
           </namingGroup>
           <namingGroup name="hpux_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>
        </namingGroupList>
        <!-- Naming group lists for Solaris  -->
        <namingGroupList name="solaris" when="@ validateKUXOSType ${HOSTINFO} ${q0.VMID} *EQ 'global'">
           <!-- Naming group for Solaris global zones or physical -->
           <namingGroup name="solaris_h">
              <namingMember>crtv:hostid</namingMember>
           </namingGroup>
           <namingGroup name="solaris_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>
        </namingGroupList>           
        <namingGroupList name="localzone" when="@ validateKUXOSType ${HOSTINFO} ${q0.VMID} *EQ 'local'">
           <!-- Naming group for Solaris local zones -->
           <namingGroup name="localzone_hv">           
              <namingMember>crtv:hostid</namingMember>
              <namingMember>crtv:vmid</namingMember>              
           </namingGroup>
           <namingGroup name="localzone_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>
        </namingGroupList>
        <metrics>health</metrics>
      </im:name>
    </im:list>
  </tmsoslc:ResourceDefinition>

  <tmsoslc:ResourceDefinition type="IPAddress">
    <im:list>
      <im:name name="IP_Resource">
       <id name="crtv:contextAddressSpace rdf:resource" value="${formatIPAddr.CONTEXTAS}" />
       <id name="crtv:address" exclude="0.0.0.0,0:0:0:0:0:0:0:0,::" value="${formatIPAddr.IPADDRESS}" />
       <namingGroupList name="IP_address">
          <namingGroup name="IP_address_group">
             <namingMember>crtv:contextAddressSpace</namingMember>
             <namingMember>crtv:address</namingMember>
           </namingGroup>
       </namingGroupList>
       <relationship type="crtv:dependsOn">
          <target>
            <resourceType>ComputerSystem</resourceType>
            <resourceName>host</resourceName>
            <scope>this</scope>
          </target>
       </relationship>
      </im:name>
    </im:list>
  </tmsoslc:ResourceDefinition>

 <metrics class="health">
    <record type="ComputerSystem">
      <metric name="itm:topProcessesforCPUUtil">
        <pattern type="sequence" name="topCPU-seq" limit="5" />
        <reference type="crtv:Process" about="${q2.BCMD}-${q2.PID}"  name="cpuUtilProcess" />
        <widget name="bar" order="1" width="200px" height="325px" title="CPU Utilization: Top 5 processes" bundle-key="cpu_util_title" bundle-name="UXBundle" />
      </metric>

      <metric name="itm:topProcessesforVirtMemUtil">
        <pattern type="sequence" name="topVirtMem-seq" limit="5" />
        <reference type="crtv:Process" about="${q3.BCMD}-${q3.PID}" name="virtMem" />
        <widget name="bar" order="2" width="200px" height="325px" title="Virtual Memory Utilization: Top 5 processes" bundle-key="vmem_util_title" bundle-name="UXBundle" />
      </metric>
  
      <metric name="itm:topProcessesForRealMemUtil">
        <pattern type="sequence" name="topRealMem-seq" limit="5" />
        <reference type="crtv:Process" about="${q4.BCMD}-${q4.PID}"  name="realMem" />
        <widget name="bar" order="3" width="200px" height="325px" title="Real Memory Utilization: Top 5 processes" bundle-key="rmem_util_title" bundle-name="UXBundle" />
      </metric> 

      <metric name="itm:disksByPercentageSpaceUsed">
        <pattern type="sequence" name="diskSpaceUsed-seq"  limit="5" />
        <reference type="crtv:StorageVolume" about="${q5.MOUNTPT}" name="diskUsed" />
        <widget name="bar" order="4" width="200px" height="325px" title="Disk Space Used: Top 5 filesystems" bundle-key="disk_used_title" bundle-name="UXBundle" />
      </metric>  

      <metric name="itm:monitoringAgentsByStatus">
        <pattern type="custom" name="monitoringAgentsStatus-seq">
		  <columnname name="${q6.STATUS}">
			<orderby>Not_Found</orderby>
			<orderby>Unknown</orderby>
			<orderby>Not_Configured</orderby>
		    <orderby>Stopped</orderby>
			<orderby>Start_Pending</orderby>
			<orderby>Stop_Pending</orderby>
			<orderby>Manually_Stopped</orderby>
			<orderby>Running</orderby>
		  </columnname>		  
		</pattern>
        <reference type="http://xmlns.com/foaf/0.1/Agent" about="${q6.PASAGTNAME}-${q6.INSTNAME}" name="agent" />
        <widget name="simple-table" order="5" width="200px" height="325px" title="Installed Agents" bundle-key="installed_agents_title" bundle-name="UXBundle" />    
      </metric>
    </record>

    <reference name="cpuUtilProcess" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q2.BCMD}-${q2.PID}-cpuUtil" reference-name="cpuUtilMetric" />
      <id name="dcterms:title" value="${q2.BCMD}" displayValue="${q2.BCMD}" column-name="Process" orderBy="2" axis="y" axis-type="string" column-bundle-key="process_title" column-bundle-name="UXBundle" />
      <id name="crtv:processId" value="${q2.PID}" />
    </reference> 
    
    <reference name="cpuUtilMetric"> 
      <id name="dcterms:title" value="CPU Utilization" bundle-key="cpu_util_metric" bundle-name="UXBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KUXCPUPercent ${q2.CPUPERCENT}" 
          displayValue="@ KUXCPUPercent ${q2.CPUPERCENT} display" 
          exclude="Not_Available,Not_Collected,0.00,-2.00,Not_Available%,Not_Collected%,0.00%,-2.00%"
          orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="UXBundle" /> 
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#CpuUsed" />
    </reference>

    <reference name="virtMem" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q3.BCMD}-${q3.PID}-virtMem" reference-name="memVirtMetric" />
      <id name="dcterms:title" value="${q3.BCMD}" column-name="Process" orderBy="2" axis="y" axis-type="string" column-bundle-key="process_title" column-bundle-name="UXBundle" />
      <id name="crtv:processId" value="${q3.PID}" />
    </reference> 

    <reference name="memVirtMetric"> 
      <id name="dcterms:title" value="Virtual Memory Utilization" bundle-key="virt_mem_metric" bundle-name="UXBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KUXGetVMemory ${q3.VSIZE} ${q1.VMTOT}" 
          displayValue="@ KUXGetVMemory ${q3.VSIZE} ${q1.VMTOT} display"
          exclude="Not_Available,Not_Collected,0.00,Not_Available%,Not_Collected%,0.00%"
          orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="UXBundle" /> 
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#VirtualMemoryUsed" />
    </reference>

    <reference name="realMem" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q4.BCMD}-${q4.PID}-realMem" reference-name="memRealMetric" />
      <id name="dcterms:title" value="${q4.BCMD}" column-name="Process" orderBy="2" axis="y" axis-type="string" column-bundle-key="process_title" column-bundle-name="UXBundle" />
      <id name="crtv:processId" value="${q4.PID}" />
    </reference> 

    <reference name="memRealMetric"> 
      <id name="dcterms:title" value="Real Memory Utilization" bundle-key="real_mem_metric" bundle-name="UXBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KUXGetMemory ${q4.SIZE} ${q1.MEMTOT}" 
          displayValue="@ KUXGetMemory ${q4.SIZE} ${q1.MEMTOT} display"
          exclude="Not_Available,Not_Collected,0.00,Not_Available%,Not_Collected%,0.00%"
          orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="UXBundle"/> 
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#RealMemoryUsed" />
    </reference>

    <reference name="diskUsed" pmr="y">
      <sub-reference  property-name="ems:observes" reference-type="ems:Measure" reference-value="diskUsed-${q5.MOUNTPT}" reference-name="diskUsedMetric" />
      <id name="dcterms:title" value="${q5.MOUNTPT}" displayValue="${q5.MOUNTPT}" column-name="Mount Point" axis="y" orderBy="2" axis-type="string" column-bundle-key="mount_point_title" column-bundle-name="UXBundle"/>
    </reference> 

    <reference name="diskUsedMetric"> 
      <id name="dcterms:title" value="Percentage space used"  bundle-key="disk_used_metric" bundle-name="UXBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KUXDiskPercent ${q5.PCTSPCUSED}" 
          displayValue="@ KUXDiskPercent ${q5.PCTSPCUSED} display"
          exclude="Not_Available,Not_Collected,0,Not_Available%,Not_Collected%,0%"
          orderBy="1" axis="x" axis-type="number" axis-range="0-100"
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="UXBundle"/> 
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#DiskSpaceUsed" />
    </reference>

    <reference name="agent" pmr="y">     
      <id name="dcterms:title" value="${q6.PASAGTNAME}" displayValue="${q6.PASAGTNAME}" column="1" column-name="Agent" column-bundle-key="agent-column-title" column-bundle-name="UXBundle" orderBy="2" />
      <id name="pm:availabilityStatus rdf:resource" value="@ AgentStatus ${q6.STATUS}" useurl="y" displayValue="@ AgentStatus ${q6.STATUS} display" bundle-key="@ AgentStatus ${q6.STATUS} bundlekey"
          bundle-name="UXBundle" column="2" column-name="Availability status" column-bundle-key="avail_status_title" column-bundle-name="UXBundle" orderBy="1" />
      <id name="itm:instanceName" value="${q6.INSTNAME}" />
    </reference>
   </metrics>  
 
  <method library="kuxutil.bin" name="KUXCPUPercent" />
  <method library="kuxutil.bin" name="KUXDiskPercent" />
  <method library="kuxutil.bin" name="KUXGetVMemory" />
  <method library="kuxutil.bin" name="KUXGetMemory" />
  <method library="kuxutil.bin" name="makeKUXSerialNumber" />
  <method library="kuxutil.bin" name="makeKUXOSType" />
  <method library="kuxutil.bin" name="makeKUXManufacturer" />
  <method library="kuxutil.bin" name="makeKUXModel" />
  <method library="kuxutil.bin" name="makeKUXSystemBoardUuid" />
  <method library="kuxutil.bin" name="makeKUXVmid" />
  <method library="kuxutil.bin" name="KUXformatIPAddress"/>  
  <method library="kuxutil.bin" name="makeKUXHostid"/>    
  <method library="kuxutil.bin" name="validateKUXOSType"/>      
  <method library="kuxutil.bin" name="makeKUXFqdn"/>
  <method library="kuxutil.bin" name="makeKUXShorthostname"/>
</oslc_template>


