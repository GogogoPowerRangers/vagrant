<!-- Licensed Materials - Property of IBM 5724-C04 (C) -->
<!-- Copyright IBM Corporation 2013. All rights reserved. -->
<!-- US Government Users Restricted Rights - Use, duplication -->
<!-- or disclosure restricted by GSA ADP Schedule Contract with IBM Corp. -->

<?xml version="1.0" encoding="UTF-8"?>
<oslc_template xmlns:tmsoslc="http://localhost.com/tmsoslc"
               xmlns:crtv="http://open-services.net/ns/crtv#"
               xmlns:im="http://tivoli-OSLC-prototypes/ns/im#">
  <!-- This section is for query assembly mapping -->
  <tmsoslc:product>KNT</tmsoslc:product>
  <tmsoslc:when>@ checkVersionRange ${VERSION} MIN '06.22.00' *EQ 1</tmsoslc:when>
  <tmsoslc:interval minutes="1440"/>
  <tmsoslc:queries>
    <!-- NTCOMPINFO query -->
    <tmsoslc:query name="q0" discovery="y">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTCOMPINFO">
        <tmsoslc:columnname>COMPDESC</tmsoslc:columnname>
        <tmsoslc:columnname>COMPID</tmsoslc:columnname>
        <tmsoslc:columnname>COMPUUID</tmsoslc:columnname>
        <tmsoslc:columnname>COMPVEND</tmsoslc:columnname>
        <tmsoslc:columnname>COMPHNAM</tmsoslc:columnname>
        <tmsoslc:columnname>COMPFQDN</tmsoslc:columnname>
        <tmsoslc:columnname>COMPNAME</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q1" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTIPADDR">
        <tmsoslc:columnname>DNSNAME</tmsoslc:columnname>
        <tmsoslc:columnname>INTFNAME</tmsoslc:columnname>
        <tmsoslc:columnname>IPADDRESS</tmsoslc:columnname>
        <tmsoslc:columnname>IPVERSION</tmsoslc:columnname>
        <tmsoslc:columnname>MACADDRESS</tmsoslc:columnname>
        <tmsoslc:columnname>TIMESTAMP</tmsoslc:columnname>
        <tmsoslc:columnname>ORIGINNODE</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q2" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTPROCSSR">
        <tmsoslc:columnname>INSTCNAME</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q3" discovery="y">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="WTSYSTEM">
        <tmsoslc:columnname>PCTTLPCSRT</tmsoslc:columnname>
        <tmsoslc:columnname>SYSUPTIME</tmsoslc:columnname>
        <tmsoslc:columnname>OSTYPE</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q4" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTMEMORY">
        <tmsoslc:columnname>MEMUPCT</tmsoslc:columnname>
        <tmsoslc:columnname>TIMESTAMP</tmsoslc:columnname>
        <tmsoslc:columnname>TOTMEMKB</tmsoslc:columnname>
        <tmsoslc:columnname>COMMITLKB</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q5" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' AND INSTCNAME *NE 'Idle' AND INSTCNAME *NE '_Total' ORDER BY PCTPRCSTME DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTPROCESS">
        <tmsoslc:columnname>INSTCNAME</tmsoslc:columnname>
        <tmsoslc:columnname>PCTPRCSTME</tmsoslc:columnname>
        <tmsoslc:columnname>IDPROCESS</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q6" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' AND INSTCNAME *NE '_Total' ORDER BY PGFLEKBYTE DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTPROCESS">
        <tmsoslc:columnname>INSTCNAME</tmsoslc:columnname>
        <tmsoslc:columnname>PGFLEKBYTE</tmsoslc:columnname>
        <tmsoslc:columnname>IDPROCESS</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q7" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY PASAGTNAME"
      </tmsoslc:where>
      <tmsoslc:tablename name="KNTPASSTAT">
        <tmsoslc:columnname>INSTNAME</tmsoslc:columnname>
        <tmsoslc:columnname>PASAGTNAME</tmsoslc:columnname>
        <tmsoslc:columnname>TIMESTAMP</tmsoslc:columnname>
        <tmsoslc:columnname>STATUS</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q8" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' ORDER BY PCUSED DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="WTLOGCLDSK">
        <tmsoslc:columnname>INSTNAMLNG</tmsoslc:columnname>
        <tmsoslc:columnname>INSTCNAME</tmsoslc:columnname>
        <tmsoslc:columnname>PCUSED</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="q9" discovery="y">
      <tmsoslc:where>
       "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}'"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTIPADDR">
        <tmsoslc:columnname>IPADDRESS</tmsoslc:columnname>
        <tmsoslc:columnname>INTFNAME</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>

    <tmsoslc:query name="formatIPAddr" discovery="y">
      <tmsoslc:method>"@ KNTformatIPAddress ${q9}"</tmsoslc:method>
    </tmsoslc:query>

    <tmsoslc:query name="q10" discovery="n">
      <tmsoslc:where>
        "SYSTEM.PARMA('NODELIST','${MSYSN}',32) AND ORIGINNODE = '${MSYSN}' AND INSTCNAME *NE '_Total' ORDER BY PRLVKBYTS DESC"
      </tmsoslc:where>
      <tmsoslc:tablename name="NTPROCESS">
        <tmsoslc:columnname>INSTCNAME</tmsoslc:columnname>
        <tmsoslc:columnname>PRLVKBYTS</tmsoslc:columnname>
        <tmsoslc:columnname>IDPROCESS</tmsoslc:columnname>
      </tmsoslc:tablename>
    </tmsoslc:query>
	
  </tmsoslc:queries>

  <tmsoslc:ResourceDefinition type="ComputerSystem">
    <im:list>
       <im:name name="os">
        <id name="itm:osType rdf:resource" value="@ KNTOSType ${q3.OSTYPE}" />
        <id name="crtv:systemBoardUUID" exclude="unknown" value="@ getOSDPsystemBoardUuid ${q0.COMPUUID}" />
        <id name="crtv:manufacturer" exclude="UNKNOWN" value="@ getOSDPmanufacturer ${q0.COMPVEND}" />
        <id name="crtv:model" exclude="UNKNOWN" value="@ getOSDPmodel ${q0.COMPNAME}" />
        <id name="crtv:serialNumber" exclude="UNKNOWN" value="@ getOSDPserialNumber ${q0.COMPID}" />
        <id name="crtv:fqdn" exclude="NO_DNS_ENTRY" value="@ KNTCheckFqdn ${q0.COMPFQDN}" />
        <id name="crtv:shortHostname" exclude="unknown" value="@ KNTCheckShorthostname ${q0.COMPHNAM}" />
       
        <namingGroupList name="windows">
           <namingGroup name="windows_mms">
              <namingMember>crtv:model</namingMember>
              <namingMember>crtv:manufacturer</namingMember>
              <namingMember>crtv:serialNumber</namingMember>
           </namingGroup>
           <namingGroup name="windows_u">
              <namingMember>crtv:systemBoardUUID</namingMember>
           </namingGroup>
           <namingGroup name="windows_fqdn">
              <namingMember>crtv:fqdn</namingMember>
           </namingGroup>
        </namingGroupList>
        
        <metrics>health</metrics>
      </im:name>
    </im:list>
  </tmsoslc:ResourceDefinition>

  <tmsoslc:ResourceDefinition type="IPAddress">
    <im:list>
      <im:name name="IP_Resource">
       <id name="crtv:contextAddressSpace rdf:resource" value="${formatIPAddr.CONTEXTAS}" />
       <id name="crtv:address" exclude="0.0.0.0,0:0:0:0:0:0:0:0,::" value="${formatIPAddr.IPADDRESS}" />
       <namingGroupList name="IP_address">
          <namingGroup name="IP_address_group">
             <namingMember>crtv:contextAddressSpace</namingMember>
             <namingMember>crtv:address</namingMember>
           </namingGroup>
       </namingGroupList>
       <relationship type="crtv:dependsOn">
          <target>
            <resourceType>ComputerSystem</resourceType>
            <resourceName>os</resourceName>
            <scope>this</scope>
          </target>
       </relationship>
      </im:name>
    </im:list>
  </tmsoslc:ResourceDefinition>

  <metrics class="health">
    <record type="ComputerSystem">
      <metric name="itm:topProcessesforCPUUtil">
        <pattern type="sequence" name="topCPU-seq" limit="5" />
        <reference type="crtv:Process" about="${q5.INSTCNAME}-${q5.IDPROCESS}"  name="cpuUtilProcess" />
         <widget name="bar" order="1" width="200px" height="325px" title="CPU Utilization: Top 5 processes" bundle-key="cpu_util_title" bundle-name="NTBundle" />
      </metric>

      <metric name="itm:topProcessesforVirtMemUtil">
        <pattern type="sequence" name="topVirtMem-seq" limit="5" />
        <reference type="crtv:Process" about="${q6.INSTCNAME}-${q6.IDPROCESS}" name="virtMem" />
        <widget name="bar" order="2" width="200px" height="325px" title="Virtual Memory Utilization: Top 5 processes" bundle-key="vmem_util_title" bundle-name="NTBundle" />
      </metric>
  
      <metric name="itm:topProcessesForRealMemUtil">
        <pattern type="sequence" name="topRealMem-seq" limit="5" />
        <reference type="crtv:Process" about="${q10.INSTCNAME}-${q10.IDPROCESS}"  name="realMem" />
        <widget name="bar" order="3" width="200px" height="325px" title="Real Memory Utilization: Top 5 processes" bundle-key="rmem_util_title" bundle-name="NTBundle" />
      </metric> 

      <metric name="itm:disksByPercentageSpaceUsed">
        <pattern type="sequence" name="diskSpaceUsed-seq"  limit="5" />
        <reference type="crtv:StorageVolume" about="${q8.INSTCNAME}" name="diskUsed" />
        <widget name="bar" order="4" width="200px" height="325px" title="Disk Space Used: Top 5 disks" bundle-key="disk_used_title" bundle-name="NTBundle" />
      </metric>  

      <metric name="itm:monitoringAgentsByStatus">
        <pattern type="custom" name="monitoringAgentsStatus-seq">
		  <columnname name="${q7.STATUS}">
			<orderby>Not_Found</orderby>
			<orderby>Unknown</orderby>
			<orderby>Not_Configured</orderby>
			<orderby>Stopped</orderby>
			<orderby>Start_Pending</orderby>
			<orderby>Stop_Pending</orderby>
			<orderby>Manually_Stopped</orderby>
			<orderby>Running</orderby>
		  </columnname>		  
		</pattern>		
        <reference type="http://xmlns.com/foaf/0.1/Agent" about="${q7.PASAGTNAME}-${q7.INSTNAME}" name="agent" />
        <widget name="simple-table" order="5" width="200px" height="325px" title="Installed Agents" bundle-key="installed_agents_title" bundle-name="NTBundle" />    
      </metric>

    </record>

    <reference name="cpuUtilProcess" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q5.INSTCNAME}-${q5.IDPROCESS}-cpuUtil" reference-name="cpuUtilMetric" />
      <id name="dcterms:title" value="${q5.INSTCNAME}" displayValue="${q5.INSTCNAME}" column-name="Process" orderBy="2" axis="y" axis-type="string" column-bundle-key="process-title" column-bundle-name="NTBundle" />
      <id name="crtv:processId" value="${q5.IDPROCESS}" />
    </reference> 

    <reference name="cpuUtilMetric"> 
      <id name="dcterms:title" value="CPU Utilization" bundle-key="cpu_util_metric" bundle-name="NTBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KNTCPUPercent ${q5.PCTPRCSTME} ${q2}" 
          displayValue="@ KNTCPUPercent ${q5.PCTPRCSTME} ${q2} display" 
          exclude="Unavailable,0.00,Unavailable%,0.00%"  
          orderBy="1" axis="x" axis-type="number" axis-range="0-100"
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="NTBundle" />
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#CpuUsed" />
    </reference>

    <reference name="virtMem" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q6.INSTCNAME}-${q6.IDPROCESS}-virtMem" reference-name="memVirtMetric" />
      <id name="dcterms:title" value="${q6.INSTCNAME}" column-name="Process" orderBy="2" axis="y" axis-type="string" column-bundle-key="process_title" column-bundle-name="NTBundle" />
      <id name="crtv:processId" value="${q6.IDPROCESS}" />
    </reference> 

    <reference name="memVirtMetric"> 
      <id name="dcterms:title" value="Virtual Memory Utilization" bundle-key="virt_mem_metric" bundle-name="NTBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KNTGetVMemory ${q6.PGFLEKBYTE} ${q4.COMMITLKB}" 
          displayValue="@ KNTGetVMemory ${q6.PGFLEKBYTE} ${q4.COMMITLKB} display" 
          exclude="Unavailable,0.00,Unavailable%,0.00%"  
          orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="NTBundle" />
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#VirtualMemoryUsed" />
    </reference>

    <reference name="realMem" pmr="y">
      <sub-reference property-name="ems:observes" reference-type="ems:Measure" reference-value="${q10.INSTCNAME}-${q10.IDPROCESS}-realMem" reference-name="memRealMetric" />
      <id name="dcterms:title" value="${q10.INSTCNAME}" column-name="Process" orderBy="2" axis="y" axis-type="string" column-bundle-key="process_title" column-bundle-name="NTBundle" />
      <id name="crtv:processId" value="${q10.IDPROCESS}" />
   </reference> 

    <reference name="memRealMetric"> 
      <id name="dcterms:title" value="Real Memory Utilization" bundle-key="real_mem_metric" bundle-name="NTBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KNTGetMemory ${q10.PRLVKBYTS} ${q4.TOTMEMKB}" 
          displayValue="@ KNTGetMemory ${q10.PRLVKBYTS} ${q4.TOTMEMKB} display" 
          exclude="Unavailable,0.00,Unavailable%,0.00%"  
          orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="NTBundle" /> 
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#RealMemoryUsed" />
    </reference>

    <reference name="diskUsed" pmr="y">
      <sub-reference  property-name="ems:observes" reference-type="ems:Measure" reference-value="diskUsed-${q8.INSTCNAME}" reference-name="diskUsedMetric" />
      <id name="dcterms:title" value="${q8.INSTCNAME}" displayValue="${q8.INSTCNAME}" column-name="Disk" axis="y" orderBy="2" column-bundle-key="disk_title" column-bundle-name="NTBundle" exclude="_Total" />
    </reference> 

    <reference name="diskUsedMetric"> 
      <id name="dcterms:title" value="Percentage Space Used" bundle-key="disk_used_metric" bundle-name="NTBundle" />
      <id name="ems:numericValue" datatype="http://www.w3.org/2001/XMLSchema#double" 
          value="@ KNTDiskPercent ${q8.PCUSED}" 
          displayValue="@ KNTDiskPercent ${q8.PCUSED} display" 
          exclude="Unavailable,0.00,Unavailable%,0.00%"  
          orderBy="1" axis="x" axis-type="number" axis-range="0-100" 
          column-name="Utilization" column-bundle-key="utilization_title" column-bundle-name="NTBundle" />
      <id name="ems:unitOfMeasure rdf:resource" value="http://dbpedia.org/resource/Percentage" />
      <id name="ems:metric rdf:resource" value="http://open-services.net/ns/perfmon#DiskSpaceUsed" />
    </reference>

    <reference name="agent" pmr="y">   
      <id name="dcterms:title" value="${q7.PASAGTNAME}" displayValue="${q7.PASAGTNAME}" column="1" column-name="Agent" column-bundle-key="agent-column-title" column-bundle-name="NTBundle" orderBy="2" />
      <id name="pm:availabilityStatus rdf:resource" value="@ AgentStatus ${q7.STATUS}" useurl="y" displayValue="@ AgentStatus ${q7.STATUS} display" bundle-key="@ AgentStatus ${q7.STATUS} bundlekey"
          bundle-name="NTBundle" column="2" column-name="Availability status" column-bundle-key="avail_status_title" column-bundle-name="NTBundle" orderBy="1" />
      <id name="itm:instanceName" value="${q7.INSTNAME}" />
    </reference>
  </metrics>  
    
  
  <method library="kntutil.bin" name="KNTOSType"/>
  <method library="kntutil.bin" name="KNTformatIPAddress"/>
  <method library="kntutil.bin" name="KNTCPUPercent"/>
  <method library="kntutil.bin" name="KNTDiskPercent"/>
  <method library="kntutil.bin" name="KNTGetMemory"/>
  <method library="kntutil.bin" name="KNTGetVMemory"/>
  <method library="kntutil.bin" name="KNTCheckFqdn"/>
  <method library="kntutil.bin" name="KNTCheckShorthostname"/>

</oslc_template>
